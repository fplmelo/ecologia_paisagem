---
title: "Week 6 - Mean Tests and Design of Experiments"
subtitle: "RMDA ARES40011"
author: "Felipe Melo"
date: "last-modified"
date-format: "long"
filters:
  - naquiz
format:
  html:
    toc: true
    toc-expanded: 3
editor: 
  markdown: 
    wrap: sentence
---
![](/img/mean_test.jpeg){width="500"}

[Artwork by \@allison_horst](https://twitter.com/allison_horst){style="text-align: center"}

# Preparation

## Learning objectives

| Research Methods | Data Analyses |
|------------------------------------|------------------------------------|
| Types of experimental designs | Understand "mean tests" |
| Error Type I and II |Parametric vs. non-parametric mean tests |
|  | Data visualization for means|


**For Data Analyses**

-   {{< fa book >}} [Check chapter this e-book, R Notes](https://brad-cannell.github.io/r_notes/contingency-tables.html)
-   {{< fa book >}} [Cookbook for R](http://www.cookbook-r.com/Manipulating_data/Converting_between_data_frames_and_contingency_tables/)
-   {{< fa tools >}} [Nice Tutorial for Contignecy Tables](https://sbc.shef.ac.uk/stats-in-r/practical.nb.html)
-   {{< fa tools >}} [Nice Tutorial for Chi-Square tests](https://www.sthda.com/english/wiki/chi-square-test-of-independence-in-r)

**For Research Methods**

-   {{< fa book >}} [What is replication?](https://en.wikipedia.org/wiki/Replication_(statistics))

-   {{< fa video >}} [Degrees of Freeedom](https://youtu.be/oFz8iOx96mw)

-   {{< fa video >}} [About statistical power and replicates in experimental design](https://youtu.be/sk5ttlX2i5I)

-   {{< fa video >}} [Understanding Replication and Randomization](https://youtu.be/Mufk0ZJVqQY)

-   {{< fa video >}} [Types of experiments](https://youtu.be/DavsDxgYQo4)

# Lesson

# Part 1 - Research Methods

## Types of experimental desing

Experimental design is a crucial process for ensuring that studies are statistically sound and that conclusions drawn from them are reliable. It involves carefully planning how data will be collected to answer a specific question.  Experimental designs are broadly classified into two main categories: 

**Single-Factor Experiments** and **Multi-Factor Experiments**.

### Single-Factor Experiments
These experiments involve varying only a single factor or treatment, while all other factors are kept constant or applied uniformly to all plots.

**1. Completely Randomized Design (CRD)**

![](/img/crd.png){fig-align=center width="300"}

In a CRD, treatments are assigned completely at random to experimental units, ensuring each unit has an equal chance of receiving any one treatment.

Homogeneity Requirement: CRD is applicable primarily when the experimental material is homogenous. It is generally used in lab experimental conditions where environmental factors can be easily controlled. Due to the typical heterogeneity of soil in fields, CRD is often not the preferred method for field experiments.

Local Control: The principle of 'Local-control' is not used in CRD.

Advantages: CRD is easy to understand, allows for a varying number of replications per treatment, offers high flexibility in the number of treatments used, requires simple statistical analysis, and provides the maximum number of degrees of freedom.


Disadvantages: It can only be applied to homogenous experiments and does not incorporate the principle of 'Local-control'.


**2. Randomized Block Design (RBD)**

![](/img/rbd.png){fig-align=center width="300"}


RBD is the most commonly used experimental design in agriculture. It incorporates 'local-control' by grouping experimental material into homogenous subgroups called blocks. Each block then contains the entire set of treatments, making a block equivalent to a replication.


Key Principles: RBD effectively utilizes all three core principles of experimental design: replication, randomization, and local-control.

Replication: In RBD, blocks are repeated across the field, often four to six times, to gather more data from a broader area and increase confidence in the results, such as yield differences.

Randomization: To eliminate bias and avoid unintended benefits from field variability (e.g., a field becoming more productive from east to west), the placement of each treatment within a block is assigned by chance, such as by flipping a coin. This ensures that any observed yield differences are genuinely due to the treatments and not other uncontrolled factors.

Advantages: RBD is generally more efficient and accurate than CRD, has a lower chance of error, offers high flexibility in the number of treatments and replications, and allows for relatively simple statistical analysis, even if a single value is missing. Errors related to any treatment can be isolated.

Disadvantages: RBD is not recommended for a very large number of treatments because this can increase the size of each block, potentially leading to heterogeneity within blocks and higher experimental errors.

**Other Noteworthy Experimental Designs**

• Randomized Two-Treatment Experiment: Involves randomly assigning individuals to one of two groups, typically an experimental condition (where the hypothesized cause is present) and a control condition (where it's absent or a placebo is given). Random assignment aims to ensure groups are similar in all respects, including pre-existing conditions.

•Rigorously Controlled Design: This design involves carefully assigning subjects to treatment groups to ensure they are similar in important ways. However, it is hard to implement due to the difficulty in identifying all relevant differentiations and should generally be avoided.

• Matched Pairs Design: Treatments are administered to two groups that are matched in certain ways. Examples include measuring the same individual's right arm versus left arm, or conducting before-and-after experiments (e.g., weight before and after a diet).

• Repeated Measures Design: In this design, all participants are exposed to all levels of the independent variable, meaning they experience all conditions. Random assignment occurs for the order in which these conditions are experienced, rather than assigning participants to specific conditions.

![](/img/plant_exp.png){fig-align=center width="300"}


:::callout-tip
All true experiments, regardless of their specific type, emphasize random assignment to conditions, which is crucial for maximizing internal validity. Replication, the repetition of an experiment on more than one subject, is also vital to ensure the sample is large enough to differentiate true effects from random ones and to allow others to duplicate results.
:::

# Part 2 - Data Analyses

## Understanding Mean Tests in R

Mean tests are statistical procedures used to determine if there are significant differences between the means of two or more groups, or if a sample mean is significantly different from a specific value. These tests are fundamental in validating relationships, especially when dealing with a categorical variable and a continuous variable. The sources highlight various tests, including t-tests, Analysis of Variance (ANOVA), and their non-parametric counterparts, the Wilcoxon rank sum test and Kruskal-Wallis test

### Introduction to Mean Tests

Mean tests are fundamental statistical tools used to **determine if there are significant differences between the average values (means) of one or more groups or against a specific hypothesised value**. They are crucial for drawing conclusions from data in various fields, including epidemiology and data science.

### Assumptions for Mean Tests

Parametric mean tests, such as the t-test and ANOVA, rely on several key assumptions about the data [5-12]. It is a best practice to **visually check data distribution and run assumption tests prior to performing any statistical tests**.

The common assumptions for parametric tests are:

*   **Independence**: The samples are independent of each other [5, 6, 10]. For example, in an unpaired t-test, the observations in one group should not be related to the observations in another group. Paired tests, however, are an exception, as they explicitly deal with related or dependent samples.

*   **Normality**: The data for each group or the differences between paired observations should be **approximately normally distributed**.
 
    *   **Checking normality**: This can be assessed using the **Shapiro-Wilk test** (`shapiro.test()` from `base` R or `shapiro_test()` from `rstatix`), which is suitable for sample sizes between 3 and 5000 observations. A p-value greater than 0.05 from this test indicates that the data distribution is not significantly different from a normal distribution, suggesting normality can be assumed.
    
    *   **Visual confirmation**: **Quantile-Quantile (Q-Q) plots** (`ggqqplot()` from `ggpubr`) or **histograms** (`geom_histogram()` with `ggplot`) are useful visual tools to assess normality [19-23]. If points in a Q-Q plot fall approximately along the reference line, normality can be assumed [19]. Statistical tests can sometimes be overly sensitive to large sample sizes or not sensitive enough at low sample sizes, making visual interpretation valuable.
    
    *   **Large Sample Sizes**: For sample sizes greater than 30 (n > 30), the **Central Limit Theorem** suggests that violations of the normality assumption should not pose major issues, allowing the use of parametric tests [25]. However, visual checks and the Shapiro-Wilk test can still help identify serious deviations.
    
*   **Homoscedasticity (Equality of Variances)**: The variance of the outcome variable should be **equal across the groups** being compared. This assumption is primarily made by the **classic Student's t-test** and standard ANOVA.
    *   **Checking homoscedasticity**: **Levene's test** (`leveneTest()` from `car` package or `levene_test()` from `rstatix`) is a robust method to compare variances. A p-value greater than 0.05 suggests that the variances are not significantly different, implying homogeneity of variances.
    *   **Visual confirmation**: Boxplots can also be used to visually examine homoscedasticity.
    *   **Handling unequal variances**: If variances are unequal, **Welch's t-test** (for two groups) or **Welch's ANOVA** (for more than two groups) are more appropriate alternatives as they do not assume equal variances. R's `t.test()` function defaults to Welch's t-test, making it a safer choice.
*   **No Significant Outliers**: **Outliers** can skew results and violate assumptions. They can be identified using boxplot methods, such as `identify_outliers()` from the `rstatix` package. If extreme outliers are present, non-parametric tests might be considered.

### Parametric vs Non-Parametric Versions

The choice between parametric and non-parametric tests largely depends on whether the data meets the assumptions of parametric tests, especially normality and homoscedasticity.

*   **Parametric Tests**:
    *   Assume specific distributions for the data (e.g., normal distribution) and often require assumptions about the equality of variances.
    *   Examples include **T-tests** and **Analysis of Variance (ANOVA)**.
    *   They are generally more powerful when their assumptions are met.

*   **Non-Parametric Tests**:
    *   Do **not rely on assumptions about the distribution of the data**.
    *   Often focus on medians or ranks rather than means.
    *   Examples include the **Wilcoxon test** (Rank-Sum test for two groups, Signed-Rank test for paired samples) and the **Kruskal-Wallis test** (for more than two groups).
    *   Recommended when parametric test assumptions are violated.

### One-sample comparisons

One-sample t-test is used to compare the mean of one sample to a known standard (or theoretical/hypothetical) mean (μ).

Generally, the theoretical mean comes from:

- A previous experiment. For example, compare whether the mean weight of mice differs from 200 mg, a value determined in a previous study.

- From an experiment where you have control and treatment conditions. If you express your data as “percent of control”, you can test whether the average value of treatment condition differs significantly from 100.

In statistics, we can define the corresponding null hypothesis (H0) as follow:

$H_0 : m=\mu$

$H_0 : m \geq \mu$

$H_0 : m \leq \mu$

The corresponding alternative hypotheses (H') are as follow:

$H': m\neq\mu$ (just different) 

$H' : m < \mu$ (smaller) 

$H' : m > \mu$ (greater)

:::callout-tip
Now, imagine the `palmerpenguins` dataset. Imagine that you are a researcher working with penguins and someone reported a carcase of a dead penguin in an island that where you know that species `Adelie` was never registered. The only precise data you have is the length of the bill found (39.2mm). Can we use a **one-sample test** for that?
:::

Let's check the mean values of bill length

```{r}
#| warning: false
library(tidyverse)
library(palmerpenguins)
penguins %>% 
  group_by(species) %>% 
  drop_na() %>% 
  summarise(bill_length_mean = mean(bill_length_mm), bill_lengh_sd = sd(bill_length_mm))

```

Let's test our possible hypotheses

1- The dead penguin is from **Adelie** species, then $H' : m < \mu$ where $\mu$ is the carcase and `m` could be the mean of other penguin species, let's say **Chinstrap**

```{r}
penguins %>% 
  filter(species=="Adelie") %>% 
  select(bill_length_mm) -> m
t.test(m, mu = 39.2, alternative = "two.sided")
t.test(m, mu = 39.2, alternative = "greater")
t.test(m, mu = 39.2, alternative = "less")

penguins %>% 
  filter(species=="Chinstrap") %>% 
  select(bill_length_mm) -> m
t.test(m, mu = 39.2, alternative = "two.sided")
t.test(m, mu = 39.2, alternative = "greater")
t.test(m, mu = 39.2, alternative = "less")

penguins %>% 
  filter(species=="Gentoo") %>% 
  select(bill_length_mm) -> m
t.test(m, mu = 39.2, alternative = "two.sided")
t.test(m, mu = 39.2, alternative = "greater")
t.test(m, mu = 39.2, alternative = "less")

```

From all comparison, the one that rejected more differences was the first (compared to Adelie), so our scientific hypotheses that the carcase might belongs to an Adelie penguins cannot be rejected. All other comparisons, rejected this scientific hypothesis.

:::callout-tip
Exactly the same logic applies to the non-parametric version of the test: **Wilcoxon test**

```{r}
penguins %>% 
  filter(species=="Adelie") %>% 
  pull(bill_length_mm)-> m # Note that I had to use the fucntion pull to extract a numeric vector rather than a tibble acecpted by t.test before
wilcox.test(m, mu = 39.2, alternative = "two.sided")
wilcox.test(m, mu = 39.2, alternative = "greater")
wilcox.test(m, mu = 39.2, alternative = "less")

```

:::

### Two(or more)-sample comparisons (independent groups)

This test is used to compare the means of two independent groups. For instance, it can compare the average weights of individuals grouped by gender. There are two primary forms:

• **Student's t-test**: Assumes that the variance of the two groups are equal.

• **Welch's t-test**: Is less restrictive and does not assume equal variances between the two groups. By default, R typically computes the Welch's t-test, which is considered the safer option, especially when group sizes and standard deviations are very different.
* **Analyses of Variance**: Works similarly as the t-test but is able to compare more than two groups and uses a different calculation to decide on whether or not to reject null hypothesis, via **F-statisticis**

**Assumptions**: 

- Independence of observations: Each subject should belong to only one group, and there should be no relationship between observations across groups.

- No significant outliers in either group.

- Normality: The data for each group should be approximately normally distributed.

- Homogeneity of variances: The variance of the outcome variable should be equal in each group. This assumption is specifically for the standard Student's t-test and is relaxed in the Welch's t-test. Homogeneity of variances can be checked using Levene's test. If variances are unequal, Welch's t-test is often preferred as it maintains a more accurate Type I error rate

**Non-Parametric Alternatives**

When the assumptions for parametric tests (like t-tests or ANOVA) are not met, particularly normality or homogeneity of variances, non-parametric alternatives are recommended.

• **Wilcoxon Rank Sum Test (Mann-Whitney U test)**: This is the non-parametric alternative to the independent samples t-test. It determines if two numeric samples are from the same distribution when populations are not normally distributed or have unequal variance, focusing on comparing medians rather than means.

• **Kruskal-Wallis Test**: This is the non-parametric alternative to one-way ANOVA. It tests for differences in the distribution of more than two samples when normality cannot be assumed. Like ANOVA, it is an "omnibus" test and typically requires pairwise Wilcoxon tests as post-hoc analyses to identify specific group differences.

## Compare two groups
Let's consider again the Penguins dataset. Can I use the bill length as helpful character to separate species?

Let's see if Chinstrap and Gentoo species differ in bill length

```{r}

## Method 1

penguins %>% 
  filter(species=="Chinstrap") %>% 
  pull(bill_length_mm)->x

penguins %>% 
  filter(species=="Gentoo") %>% 
  pull(bill_length_mm)->y

t.test(x, y, var.equal = TRUE, alternative="two.sided") # testing if they are different
t.test(x, y, alternative="greater")
t.test(x, y, alternative="less")

## Method 2

penguins %>% 
  filter(species!="Adelie")->peng.t.test 
  t.test(bill_length_mm~species, var.equal=TRUE, data = peng.t.test)
   t.test(bill_length_mm~species, var.equal=FALSE, data = peng.t.test)
```

## Compare more than two groups

**ANOVA** is used when you want to compare the means of three or more independent groups on a particular continuous variable. It tells you whether there's an overall statistically significant difference among the group means.

Let's try to determine if there is a statistically significant difference in the mean `bill length` (bill_length_mm) among the different penguin species.

- Categorical Independent Variable (Factor): species (Adelie, Chinstrap, Gentoo) - 3 levels/groups

- Continuous Dependent Variable: bill_length_mm

## State the Hypotheses

- Null Hypothesis (H0): The mean bill length is the same across all penguin species (μ_Adelie = μ_Chinstrap = μ_Gentoo)
- Alternative Hypothesis (Ha): At least one penguin species has a different mean bill length from the others. (Not all means are equal)

```{r}
anova_result <- aov(bill_length_mm ~ species, data = penguins)
summary(anova_result)
```

**Visualise the data**

```{r}
#| warning: false
penguins %>% 
  ggplot(aes(species, bill_length_mm, color=species, fill=species))+
  geom_jitter() +
  geom_boxplot(alpha=0.5)

```

We can see visually that Adelie penguins have shorter bills, but how do we get a statistic confirmation on who differs from whom?

**Post-hoc pairwise comparisons**

In this case, let's apply one of the most common tests, the `Tukey Test` for pairwise comparisons.

```{r}
TukeyHSD(anova_result)
```


Easy to see now, that actually, all species differ in their bill length and there were hidden differences that a simple visual inspection is not able to grasp.

## Summary of Statistical Tests for Mean Differences

: **Table 1: Summary of Comparisons of Statistical Tests for Analysing Mean Differences** {#tbl-statistical-tests}

| Feature                   | T-test (Parametric)                                                                                                                  | ANOVA (Parametric)                                                                                                                        | Wilcoxon Test (Non-parametric)                                                                                                              | Kruskal-Wallis Test (Non-parametric)                                                                                                  |
| :------------------------ | :----------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------ |
| **Number of Groups**      | **Two groups**, or **one sample vs. a known value**.                                                 | **Three or more groups**.                                                                                           | **Two groups**, or **one sample vs. a known value**.                                                              | **Three or more groups**. When only two samples are used, results are identical to Wilcoxon rank sum test. |
| **Dependent/Independent** | Both **independent** and **paired** variants exist.                         | Typically **independent groups**.                                                                                                  | Both **independent** (rank sum) and **paired** (signed-rank) variants exist.                          | **Independent groups**.                                                                                                         |
| **Key Assumption**        | **Normality of data** (or differences for paired) and **homogeneity of variance** (for Student's). No significant outliers. Independence of observations for independent samples. | **Normality of data** and **homogeneity of variance**. Data independence.                                         | **No specific distribution assumption** (non-parametric).                                                                       | **No specific distribution assumption** (non-parametric).                                                                       |
| **What it Compares**      | **Means**.                                                                                              | **Means**.                                                                                                                 | **Medians or distributions**.                                                                                                 | **Medians or distributions**.                                                                                           |
| **R Functions (Base)**    | `t.test()`.                                                                            | `aov()`.                                                                                                                       | `wilcox.test()`.                                                                                                               | `kruskal.test()`.                                                                                                        |
| **R Packages (Others)**   | `rstatix::t_test()`, `gtsummary::add_p()`, `report::report()`.                                                        | `gtsummary::add_p()`, `report::report()`.                                                                                  | `rstatix::wilcox_test()`, `gtsummary::add_p()`.                                                                       | `rstatix::kruskal_test()`, `gtsummary::add_p()`.                                                                |
| **Post-hoc Test Needed?** | No (compares only two groups).                                                                                                  | Yes, if omnibus test is significant (`pairwise.t.test()` or `TukeyHSD()`).                            | No (compares only two groups).                                                                                                       | Yes, if significant (`pairwise.wilcox.test()`).                                                                       |
| **Robustness**            | **Welch's is robust to unequal variances**. Generally robust to normality violations.             | Less robust to unequal variances with unbalanced sample sizes.                                                                     | Generally **more robust to assumption violations**.                                                                                 | Generally **more robust to assumption violations**. Can be unstable with heteroscedasticity.                           |
| **Relationship**          | Special case of ANOVA when comparing two groups with equal variances. Subsumed under the General Linear Model.           | Generalisation of the t-test; related to linear regression. Subsumed under the General Linear Model.                 | Non-parametric alternative to t-test.                                                                                      | Non-parametric alternative to one-way ANOVA; extension of Wilcoxon.                                                     |



## Exercises

### Experimental Desing

1- 


